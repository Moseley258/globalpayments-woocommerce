(()=>{"use strict";const e=window.React,t=window.wc.wcBlocksRegistry,o=window.wp.htmlEntities,r=window.wc.wcSettings,n=e=>document.querySelector(e),c=(e,t)=>(e?.classList.add(t),e),s=(e,t)=>(e?.classList.remove(t),e),a=e=>(e?.style&&(e.style.display="none"),e);let i={};const l=e=>(i=e,d.blockOnSubmit(),fetch(i.orderInfoUrl).then((e=>e.json())).then((e=>{i.order=e.message})).catch(((e,t,o)=>{console.log(o)})).finally((()=>{d.unblockOnError()})),{...d,order:i.order}),d={getPlaceOrderButtonSelector:()=>".wc-block-components-checkout-place-order-button",getSubmitButtonTargetSelector:e=>"#"+e+"-card-submit",getPaymentMethodRadioSelector:e=>'#payment-method input[id*="radio-control-wc-payment-method-options-'+e+'"]',getStoredPaymentMethodsRadioSelector:()=>'#payment-method input[id*="radio-control-wc-payment-method-saved-tokens-"]:checked',isOnlyGatewayMethodDisplayed:e=>{const t=[...('#payment-method input[id*="radio-control-wc-payment-method-"]',document.querySelectorAll('#payment-method input[id*="radio-control-wc-payment-method-"]'))];const o=n(d.getPaymentMethodRadioSelector(e));return t.includes(o)&&1===t.length},isFirstPaymentMethod:e=>document.querySelector("#payment-method input").value===e,toggleSubmitButtons:()=>{const e=n('#payment-method input[id*="radio-control-wc-payment-method-options-"]:checked')?.value;if(s(n(".globalpayments.card-submit"),"is-active"),i.hide.includes(e))return void d.hidePlaceOrderButton();if(!i.toggle.includes(e))return void d.showPlaceOrderButton();const t=n("#"+e+"-card-submit"),o=n(d.getStoredPaymentMethodsRadioSelector()),r=e===n(d.getStoredPaymentMethodsRadioSelector()+":checked")?.value;!o||o&&r?(c(t,"is-active"),d.hidePlaceOrderButton()):(a(t),d.showPlaceOrderButton())},hidePlaceOrderButton:()=>{a(c(n(d.getPlaceOrderButtonSelector()),"woocommerce-globalpayments-hidden"))},showPlaceOrderButton:()=>{var e;e=s(n(d.getPlaceOrderButtonSelector()),"woocommerce-globalpayments-hidden"),e?.style&&(e.style.display="")},getFormSelector:()=>"form.wc-block-components-form.wc-block-checkout__form",createInputElement:(e,t,o)=>{let r=document.getElementById(e+"-"+t);r||(r=document.createElement("input"),r.id=e+"-"+t,r.name=e+"["+t+"]",r.type="hidden",n(d.getFormSelector()).appendChild(r)),r.value=o},createSubmitButtonTarget:e=>{const t=document.createElement("div");t.id=d.getSubmitButtonTargetSelector(e).replace("#",""),t.className="globalpayments "+e+" card-submit";const o=n(d.getPlaceOrderButtonSelector());o?.parentNode.insertBefore(t,o.nextSibling),d.toggleSubmitButtons(e)},placeOrder:()=>{try{const e=n(d.getPlaceOrderButtonSelector());if(e)return void e.click()}catch(e){}n(d.getFormSelector()).submit()},showPaymentError:e=>{const t=n(d.getFormSelector());n(".woocommerce-NoticeGroup, .woocommerce-NoticeGroup-checkout, .woocommerce-error, .woocommerce-globalpayments-checkout-error")?.remove(),-1===e.indexOf("woocommerce-error")&&(e='<ul class="woocommerce-error"><li>'+e+"</li></ul>"),t?.prepend('<div class="woocommerce-NoticeGroup woocommerce-NoticeGroup-checkout woocommerce-globalpayments-checkout-error">'+e+"</div>"),n("html, body").animate({scrollTop:t.offsetTop-100},1e3),d.unblockOnError(),document.body.dispatchEvent(new Event("checkout_error"))},blockOnSubmit:()=>{const e=n(d.getFormSelector()),t=e.data?.();1!==t?.["blockUI.isBlocked"]&&e.block?.({message:null,overlayCSS:{background:"#fff",opacity:.6}})},unblockOnError:()=>{n(d.getFormSelector())?.unblock?.()},hidePaymentMethod:e=>{a(n("#payment-method #radio-control-wc-payment-method-options-"+e))},setPaymentMethodData:e=>{window.wp.data.dispatch(window.wc.wcBlocksData.PAYMENT_STORE_KEY).__internalSetPaymentMethodData(e)},dispatchInfo:({message:e,context:t="gp-wp-context",cb:o=null})=>{window.wp.data.dispatch("core/notices").createInfoNotice(e,{context:t}),o?.()},dispatchError:({message:e,context:t="gp-wp-context",cb:o=null})=>{window.wp.data.dispatch("core/notices").createErrorNotice(e,{context:t}),o?.()},hasValidationErrors:()=>window.wp.data.select(window.wc.wcBlocksData.VALIDATION_STORE_KEY).hasValidationErrors()},m=({state:e,helper:t,dispatchError:o,dispatchInfo:r,placeOrder:n})=>{var c;t.blockOnSubmit(),e.settings.helper_params.order=t.order;const s=e.tokenResponse?JSON.stringify(e.tokenResponse):null,a=null!==(c=document.querySelector(t.getStoredPaymentMethodsRadioSelector())?.value)&&void 0!==c?c:"new";return GlobalPayments.ThreeDSecure.checkVersion(e.threedsecure.checkEnrollmentUrl,{tokenResponse:s,wcTokenId:a,order:{id:e.settings.helper_params.order.id,amount:e.settings.helper_params.order.amount,currency:e.settings.helper_params.order.currency}}).then((r=>{if(r.error)return o(r.message),!1;if("NOT_ENROLLED"===r.status&&"YES"!==r.liabilityShift)return o("Please try again with another card."),!1;if("NOT_ENROLLED"===r.status&&"YES"===r.liabilityShift)return n(),!0;const c=!document.querySelector('.wc-block-checkout__use-address-for-billing input[type="checkbox"]')?.checked,i={streetAddress1:document.querySelector("#billing-address_1")?.value,streetAddress2:document.querySelector("#billing-address_2")?.value,city:document.querySelector("#billing-city")?.value,state:document.querySelector("#billing-state input")?.value,postalCode:document.querySelector("#billing-postcode")?.value,country:document.querySelector("#billing-country input")?.value},l=c?i:{streetAddress1:document.querySelector("#shipping-address_1")?.value,streetAddress2:document.querySelector("#shipping-address_2")?.value,city:document.querySelector("#shipping-city")?.value,state:document.querySelector("#shipping-state input")?.value,postalCode:document.querySelector("#shipping-postcode")?.value,country:document.querySelector("#shipping-country input")?.value};GlobalPayments.ThreeDSecure.initiateAuthentication(e.threedsecure.initiateAuthenticationUrl,{tokenResponse:s,wcTokenId:a,versionCheckData:r,challengeWindow:{windowSize:GlobalPayments.ThreeDSecure.ChallengeWindowSize.Windowed500x600,displayMode:"lightbox"},order:{id:e.settings.helper_params.order.id,amount:e.settings.helper_params.order.amount,currency:e.settings.helper_params.order.currency,billingAddress:i,shippingAddress:l,addressMatchIndicator:c,customerEmail:document.querySelector(".wc-block-components-address-form__email input#email").value}}).then((c=>{if(c.error)return o(c.message),!1;const s=c.serverTransactionId||c.challenge.response.data.threeDSServerTransID||r.serverTransactionId;return t.createInputElement(e.settings.id,"serverTransId",s),e.serverTransId=s,n(),!0})).catch((e=>(console.error(e),console.error(e.reasons),o("Something went wrong while doing 3DS processing."),!1)))})).catch((e=>(console.error(e),console.error(e.reasons),o("Something went wrong while doing 3DS processing."),!1))),document.addEventListener("click",(e=>{e.target.matches('img[id^="GlobalPayments-frame-close-"]')&&window.parent.postMessage({data:{transStatus:"N"},event:"challengeNotification"},window.location.origin)})),!1},u={settings:null,onSubmit:null,serverTransId:""};let p={};const h=t=>{const{id:o,onSubmit:n,eventRegistration:c}=t;u.onSubmit=n;const s=(0,r.getSetting)(o+"_data",{});p=l(s.helper_params),u.settings=s,u.threedsecure=s.threedsecure;const{onCheckoutFail:a}=c;(0,e.useEffect)((()=>{window.onload=()=>{g()};const e=a((()=>{S(),y()}));return()=>{e()}}),[a]);const{StoreNoticesContainer:i}=window.wc.blocksCheckout;return(0,e.createElement)(i,{context:"gp-wp-context"})},g=()=>{document.querySelector(p.getPlaceOrderButtonSelector()).addEventListener("click",(e=>{document.querySelector(p.getStoredPaymentMethodsRadioSelector())&&(e.preventDefault(),e.stopImmediatePropagation(),v())}))},y=()=>{document.querySelector("#wc-block-components-spinner")?.remove()},S=()=>{document.querySelector(p.getFormSelector()).classList.remove("wc-block-components-checkout-step--disabled"),document.querySelectorAll(`${p.getFormSelector()} > *`).forEach((e=>{e.style.pointerEvents=""}))},w=e=>{p.dispatchInfo({message:e,cb:()=>{y(),S()}})},b=e=>{p.dispatchError({message:e,cb:()=>{y(),S()}})},v=()=>{if(p.hasValidationErrors())return y(),S(),void document.querySelector(".has-error").scrollIntoView({behavior:"smooth",block:"center",inline:"start"});u.settings.gateway_options.enableThreeDSecure?((()=>{const e=document.querySelector(p.getPlaceOrderButtonSelector()),t=document.createElement("span");t.id="wc-block-components-spinner",t.classList.add("wc-block-components-spinner"),e.appendChild(t)})(),document.querySelector(p.getFormSelector()).classList.add("wc-block-components-checkout-step--disabled"),document.querySelectorAll(`${p.getFormSelector()} > *`).forEach((e=>{e.style.pointerEvents="none"})),m({state:u,helper:p,dispatchError:b,dispatchInfo:w,placeOrder:()=>{const e=window.wp.data.select(window.wc.wcBlocksData.PAYMENT_STORE_KEY).getPaymentMethodData();e.serverTransId=u.serverTransId,p.setPaymentMethodData(e),u.onSubmit()}})):u.onSubmit()},f=n=>{const{id:c,Content:s}=n,a=(0,r.getSetting)(c+"_data",{});if(0===Object.entries(a).length)return;const i=(0,o.decodeEntities)(a.title),l={name:c,label:(0,e.createElement)((t=>{const{PaymentMethodLabel:o}=t.components;return(0,e.createElement)(o,{text:i})}),null),content:s,edit:s,savedTokenComponent:(0,e.createElement)(h,{id:c}),canMakePayment:()=>!a.gateway_options.hide||!a.gateway_options.error||(console.error(a.gateway_options.message),!1),ariaLabel:i,supports:{features:a.supports,showSaveOption:a.allow_card_saving}};(0,t.registerPaymentMethod)(l)},k={settings:null,cardForm:null,tokenResponse:null,fieldOptions:null,serverTransId:null};let E={};const _=t=>{const{id:o,eventRegistration:n}=t,c=(0,r.getSetting)(o+"_data",{}),s=Object.entries(c.secure_payment_fields),{StoreNoticesContainer:a}=window.wc.blocksCheckout;E=l(c.helper_params),k.settings=c,k.fieldOptions=c.secure_payment_fields,k.threedsecure=c.threedsecure;const{onCheckoutFail:i}=n;return(0,e.useEffect)((()=>{P();const e=i((()=>{F(),I()}));return()=>{document.querySelector(E.getPaymentMethodRadioSelector(k.settings.id))?.checked||(document.querySelector(E.getSubmitButtonTargetSelector(k.settings.id))?.remove(),E.showPlaceOrderButton()),e()}}),[i]),(0,e.createElement)(e.Fragment,null,(0,e.createElement)("div",{dangerouslySetInnerHTML:{__html:k.settings.environment_indicator}}),s.map((t=>(0,e.createElement)(O,{id:o,field:t[1],key:t[0]}))),(0,e.createElement)(a,{context:"gp-wp-context"}))},O=t=>{const{id:o,field:r}=t;return(0,e.createElement)("div",{className:`globalpayments ${o} ${r.class}`},(0,e.createElement)("label",{htmlFor:`${o}-${r.class}`},r.label,(0,e.createElement)("span",{className:"required"},"*")),(0,e.createElement)("div",{id:`${o}-${r.class}`}))},P=()=>{document.querySelector("#order_review, #add_payment_method")?.addEventListener("click",(e=>{e.target.matches('#payment-method input[type="radio"]')&&E.toggleSubmitButtons()})),document.body.addEventListener("checkout_error",(()=>{document.querySelector("#globalpayments_gpapi-serverTransId")?.remove()})),document.addEventListener("globalpayments_pay_order_modal_loaded",T),document.addEventListener("globalpayments_pay_order_modal_error",((e,t)=>{E.showPaymentError(t)})),(E.isFirstPaymentMethod(k.settings.id)||E.isOnlyGatewayMethodDisplayed(k.settings.id))&&(window.onload=()=>{T()}),document.querySelector("#radio-control-wc-payment-method-options-globalpayments_gpapi").addEventListener("change",T)},T=()=>{const e=k.settings.gateway_options;e.error&&D(e.message),document.querySelector(E.getSubmitButtonTargetSelector(k.settings.id))||E.createSubmitButtonTarget(k.settings.id);const t=GlobalPayments;t.configure(e),t.on("error",L),k.cardForm=t.ui.form({fields:N(),styles:C()}),k.cardForm.on("submit","click",(()=>{q(),B(),E.blockOnSubmit()})),k.cardForm.on("token-success",A),k.cardForm.on("token-error",L),k.cardForm.on("error",L),k.cardForm.on("card-form-validity",(e=>{e||(E.unblockOnError(),I(),F())})),k.cardForm.ready((()=>{E.toggleSubmitButtons()}))},q=()=>{const e=document.querySelector(E.getSubmitButtonTargetSelector(k.settings.id));e.classList.add("wc-block-components-spinner"),e.classList.add("wc-block-components-checkout-step--disabled"),e.style.height="initial !important",e.style.width="initial !important",e.style.position="relative"},I=()=>{const e=document.querySelector(E.getSubmitButtonTargetSelector(k.settings.id));e.classList.remove("wc-block-components-spinner"),e.classList.remove("wc-block-components-checkout-step--disabled"),e.style.height="initial !important",e.style.width="initial !important",e.style.position="relative"},B=()=>{document.querySelector(E.getFormSelector()).classList.add("wc-block-components-checkout-step--disabled"),document.querySelectorAll(`${E.getFormSelector()} > *`).forEach((e=>{e.style.pointerEvents="none"}))},F=()=>{document.querySelector(E.getFormSelector()).classList.remove("wc-block-components-checkout-step--disabled"),document.querySelectorAll(`${E.getFormSelector()} > *`).forEach((e=>{e.style.pointerEvents=""}))},M=e=>{E.dispatchInfo({message:e,cb:()=>{I(),F()}})},D=e=>{E.dispatchError({message:e,cb:()=>{I(),F()}})},x=e=>{D(k.settings.secure_payment_fields[e].messages.validation),E.unblockOnError()},L=e=>{if(e.reasons)for(let t=0;t<e.reasons.length;t++){const o=e.reasons[t];"NOT_AUTHENTICATED"===o.code?D("We're not able to process this payment. Please refresh the page and try again."):D(o.message)}else D("Something went wrong. Please contact us to get assistance.")},N=()=>{const e={"card-number":{placeholder:k.fieldOptions["card-number-field"].placeholder,target:"#"+k.settings.id+"-"+k.fieldOptions["card-number-field"].class},"card-expiration":{placeholder:k.fieldOptions["card-expiry-field"].placeholder,target:"#"+k.settings.id+"-"+k.fieldOptions["card-expiry-field"].class},"card-cvv":{placeholder:k.fieldOptions["card-cvc-field"].placeholder,target:"#"+k.settings.id+"-"+k.fieldOptions["card-cvc-field"].class},submit:{text:R(),target:"#"+k.settings.id+"-card-submit"}};return k.fieldOptions.hasOwnProperty("card-holder-name-field")&&(e["card-holder-name"]={placeholder:k.fieldOptions["card-holder-name-field"].placeholder,target:"#"+k.settings.id+"-"+k.fieldOptions["card-holder-name-field"].class}),e},R=()=>document.querySelector(E.getPlaceOrderButtonSelector()).innerText,C=()=>JSON.parse(k.settings.field_styles),A=e=>{if(E.hasValidationErrors())return I(),F(),document.querySelector(".has-error")?.scrollIntoView({behavior:"smooth",block:"center",inline:"start"}),void E.placeOrder();$(e)&&(k.tokenResponse=e,G())},G=()=>{k.settings.gateway_options.enableThreeDSecure?m({state:k,helper:E,dispatchError:D,dispatchInfo:M,placeOrder:Y}):Y()},Y=()=>{"function"==typeof k.cardForm.frames["card-cvv"].getCvv?k.cardForm.frames["card-cvv"].getCvv().then((e=>{k.tokenResponse&&(k.tokenResponse.details.cardSecurityCode=e),V()})):V()},$=e=>{if(e.details){const t=new Date(e.details.expiryYear,e.details.expiryMonth-1),o=new Date,r=new Date(o.getFullYear(),o.getMonth());if(!e.details.expiryYear||!e.details.expiryMonth||t<r)return x("card-expiry-field"),!1}return!(e.details&&!e.details.cardSecurityCode&&(x("card-cvc-field"),1))},V=()=>{const e={token_response:JSON.stringify(k.tokenResponse)};k.serverTransId&&(e.serverTransId=k.serverTransId),E.setPaymentMethodData(e),E.placeOrder()},U=["globalpayments_gpapi"];for(let t of U)f({id:t,Content:(0,e.createElement)(_,{id:t})})})();